{"version":3,"sources":["../src/aplus_poll.js"],"names":["define","jQuery","$","window","defaults","poll_url_attr","ready_url_attr","poll_delays","message_selector","message_attr","error","timeout","AplusExercisePoll","element","callback","options","settings","extend","url","count","init","prototype","show","attr","schedule","poll","poller","ajax","dataType","fail","message","ready","done","data","trim","is","length","setTimeout","get","removeData","ready_url","location","messageType","find","removeClass","text","res_elem","height","addClass","fn","each","aplusExerciseDetectWaits","selector","$selector","aplusExercisePoll","document"],"mappings":"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","sourcesContent":["/**\n * Submission status poller from A+. It polls Moodle about the status of\n * a submission, i.e., if it has been graded yet. The JS code is wrapped\n * into an AMD module for Moodle.\n *\n * In an HTML page, run the following JS code once to activate it:\n * // Initialize the submission status poller\n * // if $(\".exercise-wait\") is the poller element in the page\n * jQuery(function() { jQuery.aplusExerciseDetectWaits(); });\n * // otherwise\n * jQuery(function() { $(\".elementselector\").aplusExercisePoll(callback); });\n *\n * Source: A+ (a-plus/exercise/static/exercise/poll.js)\n * License: GNU GPL v3\n *\n * @module mod_astra/aplus_poll\n */\ndefine(['jquery'], function(jQuery) {\n\n    /**\n     * Polling for exercise status.\n     *\n     */\n    ;(function($, window, document, undefined) {\n        \"use strict\";\n\n        var pluginName = \"aplusExercisePoll\";\n        var defaults = {\n            poll_url_attr: \"data-poll-url\",\n            ready_url_attr: \"data-ready-url\", // new: not in A+ version\n            poll_delays: [2,3,5,5,5,10,10,10,10],\n            message_selector: \".progress-bar\",\n            message_attr: {\n                error: \"data-msg-error\",\n                timeout: \"data-msg-timeout\"\n            }\n        };\n\n        function AplusExercisePoll(element, callback, options) {\n            this.element = $(element);\n            this.callback = callback;\n            this.settings = $.extend({}, defaults, options);\n            this.url = null;\n            this.count = 0;\n            this.init();\n        }\n\n        $.extend(AplusExercisePoll.prototype, {\n\n            /**\n             * Constructs contained exercise elements.\n             */\n            init: function() {\n                this.element.show();\n                this.url = this.element.attr(this.settings.poll_url_attr);\n                this.schedule();\n            },\n\n            poll: function(firstTime) {\n                var poller = this;\n                $.ajax(this.url, {dataType: \"html\"})\n                    .fail(function() {\n                        poller.message(\"error\");\n                        poller.ready(true);\n                    })\n                    .done(function(data) {\n                        poller.count++;\n                        if (data.trim() === \"ready\" || data.trim() === \"error\" || data.trim() === \"unofficial\") {\n                            poller.ready();\n                        } else if (poller.element.is(\":visible\")) {\n                            if (poller.count < poller.settings.poll_delays.length) {\n                                poller.schedule();\n                            } else {\n                                poller.message(\"timeout\");\n                                poller.ready(true);\n                            }\n                        }\n                    });\n            },\n\n            schedule: function() {\n                var poller = this;\n                setTimeout(function() { poller.poll(); },\n                    this.settings.poll_delays[this.count] * 1000);\n            },\n\n            ready: function(error) {\n                // If there were no errors, the error parameter is undefined.\n                //this.element.hide();\n\n                // For active elements the element to which the poll plugin is attached remains the same, so to\n                // be able to submit the same form several times the plugin data needs to be removed when the\n                // evaluation and polling is finished.\n                if ($.data(this.element.get(0), \"plugin_\" + pluginName)) $.removeData(this.element.get(0), \"plugin_\" + pluginName);\n\n                //var suburl = this.url.substr(0, this.url.length - \"poll/\".length); // changed from A+\n                // added a data attribute for reading the final target URL since in Moodle it can not be a substring of the poll URL\n                var ready_url = this.element.attr(this.settings.ready_url_attr);\n                if (this.callback) {\n                    this.callback(ready_url, error);\n                } else {\n                    window.location = ready_url;\n                }\n            },\n\n            message: function(messageType) {\n                this.element.find(this.settings.message_selector).removeClass(\"progress-bar-animated\")\n                    .text(this.element.attr(this.settings.message_attr[messageType]));\n                if (this.element.attr('data-aplus-active-element')) {\n                    var message = \"There was an error while evaluating the element.\";\n                    if (messageType == \"timeout\") {\n                        message = \"Evaluation was timed out.\";\n                    }\n                    var res_elem = this.element.find(\".ae_result\").text(message);\n                    if (res_elem.height() === 0) res_elem.height(\"auto\");\n                    if ($.data(this.element.get(0), \"plugin_\" + pluginName)) {\n                        $.removeData(this.element.get(0), \"plugin_\" + pluginName);\n                    }\n                } else if (messageType == \"error\") {\n                    this.element.find(this.settings.message_selector).addClass(\"bg-danger\");\n                }\n            },\n        });\n\n        $.fn[pluginName] = function(callback, options) {\n            return this.each(function() {\n                if (!$.data(this, \"plugin_\" + pluginName)) { // This apparently blocks re-polling for a same exercise multiple times\n                    $.data(this, \"plugin_\" + pluginName, new AplusExercisePoll(this, callback, options));\n                }\n            });\n        };\n\n        $.aplusExerciseDetectWaits = function(callback, selector) {\n            selector = selector || \".exercise-wait\";\n            var $selector = $(selector);\n            if ($selector.length) {\n                $selector.aplusExercisePoll(callback);\n                return true;\n            }\n            return false;\n        };\n\n    })(jQuery, window, document);\n\n    return {}; // for AMD, no names are exported to the outside\n    }); // end define\n"],"file":"aplus_poll.min.js"}